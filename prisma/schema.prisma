generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Status {
  ACTIVE
  INACTIVE
}

enum Plan {
  START
  PRO
  BUSINESS
}

enum Product {
  INDUSTRY
}

enum Role {
  EMPLOYEE   
  MANAGER    
  OWNER      
}

enum MaritalStatus {
  SINGLE     
  MARRIED    
  DIVORCED   
  WIDOWED    
  SEPARATED  
  OTHER      
}

enum CustomerType {
  INDIVIDUAL
  BUSINESS
}

model Country {
  id              Int        @id @default(autoincrement())
  name            String
  isoCode         String     @unique @db.Char(3)
  states          State[]
  enterprises     Enterprise[]
  people          Person[]
  deliveryAddress DeliveryAddress[]

  @@map("country")
}

model State {
  id              Int        @id @default(autoincrement())
  countryId       Int
  name            String
  uf              String     @unique @db.Char(2)
  ibgeCode        Int        @unique
  country         Country    @relation(fields: [countryId], references: [id])
  cities          City[]
  enterprises     Enterprise[]
  people          Person[]
  deliveryAddress DeliveryAddress[]

  @@map("state")
}

model City {
  id              Int        @id @default(autoincrement())
  stateId         Int
  name            String
  ibgeCode        Int        @unique
  state           State      @relation(fields: [stateId], references: [id])
  enterprises     Enterprise[]
  people          Person[]
  deliveryAddress DeliveryAddress[]

  @@map("city")
}

model Enterprise {
  id                Int        @id @default(autoincrement())
  countryId         Int
  stateId           Int
  cityId            Int
  name              String?    // Nome Fantasia / Apelido
  legalName         String?    // Razão Social / Nome
  taxId             String?    // CNPJ/CPF
  responsiblePerson String?    // Responsável
  email             String?
  phone             String?
  cellphone         String?
  stateRegistration String?    // IE
  cityRegistration  String?    // IM
  maritalStatus     MaritalStatus? // Estado Civil
  neighborhood      String?    // Bairro
  street            String?    // Rua
  number            String?    // Número
  complement        String?    // Complemento
  postalCode        String?    // CEP
  notes             String?
  logo              String?   
  product           Product    @default(INDUSTRY)
  plan              Plan       @default(START)
  status            Status     @default(ACTIVE)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  country           Country    @relation(fields: [countryId], references: [id])
  state             State      @relation(fields: [stateId], references: [id])
  city              City       @relation(fields: [cityId], references: [id])
  people            Person[]
  users             User[]
  audits            Audit[]
  logs              Log[]
  customers         Customer[]
  deliveryAddress   DeliveryAddress[]
  tokens            Token[]

  @@unique([taxId, countryId, stateId, cityId]) // CNPJ único no contexto da localização
  @@map("enterprise")
}

model Person {
  id             Int        @id @default(autoincrement())
  enterpriseId   Int
  countryId      Int?
  stateId        Int?
  cityId         Int?
  name           String?    // Nome Fantasia / Apelido
  legalName      String?    // Razão Social / Nome
  taxId          String?    // CNPJ/CPF
  nationalId     String?    // RG
  maritalStatus  MaritalStatus? // Estado Civil
  neighborhood   String?    // Bairro
  street         String?    // Rua
  number         String?    // Número
  complement     String?    // Complemento
  postalCode     String?    // CEP
  notes          String?
  email          String?
  phone          String?
  cellphone      String?
  dateOfBirth    DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  enterprise     Enterprise @relation(fields: [enterpriseId], references: [id])
  country        Country?   @relation(fields: [countryId], references: [id])
  state          State?     @relation(fields: [stateId], references: [id])
  city           City?      @relation(fields: [cityId], references: [id])
  users          User[]
  customer       Customer[]

  @@unique([enterpriseId, taxId])
  @@map("person")
}

model User {
  id           Int         @id @default(autoincrement())
  enterpriseId Int
  personId     Int         @unique
  username     String      @unique
  password     String
  status       Status      @default(ACTIVE)
  role         Role        @default(EMPLOYEE)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  enterprise   Enterprise  @relation(fields: [enterpriseId], references: [id])
  person       Person      @relation(fields: [personId], references: [id])
  tokens       Token[]
  audits       Audit[]

  @@map("user")
}

model Customer {
  id              Int          @id @default(autoincrement())
  enterpriseId    Int
  personId        Int          @unique
  status          Status       @default(ACTIVE)
  type            CustomerType @default(INDIVIDUAL)
  contactName     String?     // nome da pessoa de contato
  contactPhone    String?
  contactEmail    String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  enterprise      Enterprise   @relation(fields: [enterpriseId], references: [id])
  person          Person       @relation(fields: [personId], references: [id])
  deliveryAddress DeliveryAddress[]

  @@map("customer")
}

model DeliveryAddress {
  id             Int         @id @default(autoincrement())
  customerId     Int
  enterpriseId   Int
  label          String?     // Ex: "Matriz", "Filial Porto Alegre", "Armazém"
  street         String?
  number         String?
  neighborhood   String?
  complement     String?
  reference      String?
  postalCode     String?
  cityId         Int
  stateId        Int
  countryId      Int?
  isDefault      Boolean     @default(false)
  status         Status      @default(ACTIVE)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  customer       Customer    @relation(fields: [customerId], references: [id])
  enterprise     Enterprise  @relation(fields: [enterpriseId], references: [id])
  city           City        @relation(fields: [cityId], references: [id])
  state          State?      @relation(fields: [stateId], references: [id])
  country        Country?    @relation(fields: [countryId], references: [id])

  @@map("deliveryAddress")
}

model Token {
  id           Int       @id @default(autoincrement())
  userId       Int
  enterpriseId Int
  token        String    @unique @db.VarChar(512)
  valid        Boolean   @default(true)
  createdAt    DateTime  @default(now())
  expiresAt    DateTime

  user         User      @relation(fields: [userId], references: [id])
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  @@index([userId])
  @@map("token")
}

model Audit {
  id            Int        @id @default(autoincrement())
  userId        Int
  enterpriseId  Int
  action        String
  entity        String?
  createdAt     DateTime   @default(now())

  user          User       @relation(fields: [userId], references: [id])
  enterprise    Enterprise @relation(fields: [enterpriseId], references: [id])

  @@map("audit")
}

model Log {
  id            Int        @id @default(autoincrement())
  message       String
  stack         String?    @db.Text
  context       String?
  enterpriseId  Int?
  createdAt     DateTime   @default(now())

  enterprise    Enterprise? @relation(fields: [enterpriseId], references: [id])

  @@map("log")
}
