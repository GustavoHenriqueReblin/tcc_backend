generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Status {
  ACTIVE
  INACTIVE
}

enum Plan {
  START
  PRO
  BUSINESS
}

enum Branch {
  INDUSTRY
}

enum Role {
  EMPLOYEE   
  MANAGER    
  OWNER      
}

enum MaritalStatus {
  SINGLE     
  MARRIED    
  DIVORCED   
  WIDOWED    
  SEPARATED  
  OTHER      
}

enum PersonType {
  INDIVIDUAL
  BUSINESS
}

enum ProductDefinitionType {
  RAW_MATERIAL          // Matéria-prima
  FINISHED_PRODUCT      // Produto acabado
  RESALE_PRODUCT        // Produto para revenda
  IN_PROCESS_PRODUCT    // Produto em processo de fabricação
  COMPONENT             // Componente usado na montagem
  CONSUMABLE_MATERIAL   // Material de consumo (uso interno)
  PACKAGING_MATERIAL    // Material de embalagem
  BY_PRODUCT            // Subproduto
  RETURNED_PRODUCT       // Produto devolvido
}

enum MovementType {
  IN
  OUT
}

enum MovementSource {
  PURCHASE   // entrada comprada
  HARVEST    // entrada colhida
  SALE       // saída por pedido
  ADJUSTMENT // ajuste manual
}

model Country {
  id              Int        @id @default(autoincrement())
  name            String     @db.VarChar(40)
  isoCode         String     @unique @db.Char(3)
  states          State[]
  enterprises     Enterprise[]
  people          Person[]
  deliveryAddress DeliveryAddress[]

  @@map("country")
}

model State {
  id              Int        @id @default(autoincrement())
  countryId       Int
  name            String     @db.VarChar(40)
  uf              String     @unique @db.Char(2)
  ibgeCode        Int        @unique
  country         Country    @relation(fields: [countryId], references: [id])
  cities          City[]
  enterprises     Enterprise[]
  people          Person[]
  deliveryAddress DeliveryAddress[]

  @@map("state")
}

model City {
  id              Int        @id @default(autoincrement())
  stateId         Int
  name            String     @db.VarChar(60)
  ibgeCode        Int        @unique
  state           State      @relation(fields: [stateId], references: [id])
  enterprises     Enterprise[]
  people          Person[]
  deliveryAddress DeliveryAddress[]

  @@map("city")
}

model Enterprise {
  id                Int            @id @default(autoincrement())
  countryId         Int    
  stateId           Int    
  cityId            Int    
  name              String?        @db.VarChar(80) // Nome Fantasia / Apelido
  legalName         String?        @db.VarChar(80) // Razão Social / Nome
  taxId             String?        @db.VarChar(20) // CNPJ/CPF
  responsiblePerson String?        @db.VarChar(40) // Responsável
  email             String?    
  phone             String?    
  cellphone         String?    
  stateRegistration String?        @db.VarChar(40) // IE
  cityRegistration  String?        @db.VarChar(40) // IM
  maritalStatus     MaritalStatus? // Estado Civil
  neighborhood      String?        @db.VarChar(40) // Bairro
  street            String?        @db.VarChar(40) // Rua
  number            String?        @db.VarChar(40)// Número
  complement        String?        @db.VarChar(80) // Complemento
  postalCode        String?        @db.VarChar(20) // CEP
  notes             String?    
  logo              String?       
  branch            Branch         @default(INDUSTRY)
  plan              Plan           @default(START)
  status            Status         @default(ACTIVE)
  createdAt         DateTime       @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt         DateTime       @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
    
  country           Country        @relation(fields: [countryId], references: [id])
  state             State          @relation(fields: [stateId], references: [id])
  city              City           @relation(fields: [cityId], references: [id])
  people            Person[]
  users             User[]
  audits            Audit[]
  logs              Log[]
  customers         Customer[]
  suppliers         Supplier[]
  deliveryAddress   DeliveryAddress[]
  tokens            Token[]
  productDefinition ProductDefinition[]
  unity             Unity[]
  product           Product[]
  productInventory  ProductInventory[]
  warehouse         Warehouse[]
  inventoryMovement InventoryMovement[]

  @@unique([taxId, countryId, stateId, cityId]) // CNPJ único no contexto da localização
  @@map("enterprise")
}

model Person {
  id             Int            @id @default(autoincrement())
  enterpriseId   Int
  countryId      Int?
  stateId        Int?
  cityId         Int?
  name           String?        @db.VarChar(80) // Nome Fantasia / Apelido
  legalName      String?        @db.VarChar(80) // Razão Social / Nome
  taxId          String?        @db.VarChar(20) // CNPJ/CPF
  nationalId     String?        @db.VarChar(20) // RG
  maritalStatus  MaritalStatus? // Estado Civil
  neighborhood   String?        @db.VarChar(80) // Bairro
  street         String?        @db.VarChar(80) // Rua
  number         String?        @db.VarChar(40) // Número
  complement     String?        @db.VarChar(80) // Complemento
  postalCode     String?        @db.VarChar(20) // CEP
  notes          String?        
  email          String?        @db.VarChar(40)
  phone          String?        @db.VarChar(40)
  cellphone      String?        @db.VarChar(40)
  dateOfBirth    DateTime?
  createdAt      DateTime       @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt      DateTime       @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
    
  enterprise     Enterprise     @relation(fields: [enterpriseId], references: [id])
  country        Country?       @relation(fields: [countryId], references: [id])
  state          State?         @relation(fields: [stateId], references: [id])
  city           City?          @relation(fields: [cityId], references: [id])
  users          User[]
  customer       Customer[]
  suppliers      Supplier[]

  @@unique([enterpriseId, taxId])
  @@map("person")
}

model User {
  id           Int         @id @default(autoincrement())
  enterpriseId Int
  personId     Int         @unique
  username     String      @unique
  password     String      @db.VarChar(80)
  status       Status      @default(ACTIVE)
  role         Role        @default(EMPLOYEE)
  createdAt    DateTime    @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt    DateTime    @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))

  enterprise   Enterprise  @relation(fields: [enterpriseId], references: [id])
  person       Person      @relation(fields: [personId], references: [id])
  tokens       Token[]
  audits       Audit[]

  @@map("user")
}

model Customer {
  id              Int          @id @default(autoincrement())
  enterpriseId    Int
  personId        Int          @unique
  status          Status       @default(ACTIVE)
  type            PersonType   @default(INDIVIDUAL)
  contactName     String?      @db.VarChar(80) // nome da pessoa de contato
  contactPhone    String?      @db.VarChar(20)
  contactEmail    String?      @db.VarChar(40)
  createdAt       DateTime     @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt       DateTime     @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))

  enterprise      Enterprise   @relation(fields: [enterpriseId], references: [id])
  person          Person       @relation(fields: [personId], references: [id])
  deliveryAddress DeliveryAddress[]

  @@map("customer")
}

model Supplier {
  id                Int                 @id @default(autoincrement())
  enterpriseId      Int      
  personId          Int                 @unique
  status            Status              @default(ACTIVE)
  type              PersonType          @default(BUSINESS)
  contactName       String?             @db.VarChar(80)  // Nome do contato principal
  contactPhone      String?             @db.VarChar(20)
  contactEmail      String?             @db.VarChar(40)
  website           String?             @db.VarChar(100)
  paymentTerms      String?             @db.VarChar(40)  // Prazo de pagamento (ex: 30 dias)
  deliveryTime      String?             @db.VarChar(40)  // Tempo médio de entrega
  category          String?             @db.VarChar(60)  // Ex: embalagens, frutas, transporte
  notes             String?             
  createdAt         DateTime            @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt         DateTime            @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
      
  enterprise        Enterprise          @relation(fields: [enterpriseId], references: [id])
  person            Person              @relation(fields: [personId], references: [id])
  inventoryMovement InventoryMovement[]  

  @@map("supplier")
}

model DeliveryAddress {
  id             Int         @id @default(autoincrement())
  customerId     Int
  enterpriseId   Int
  label          String?     @db.VarChar(40) // Ex: "Matriz", "Filial Porto Alegre", "Armazém"
  street         String?     @db.VarChar(80)
  number         String?     @db.VarChar(40)
  neighborhood   String?     @db.VarChar(40)
  complement     String?     @db.VarChar(80)
  reference      String?     @db.VarChar(80)
  postalCode     String?     @db.VarChar(20)
  cityId         Int
  stateId        Int
  countryId      Int?
  isDefault      Boolean     @default(false)
  status         Status      @default(ACTIVE)
  createdAt      DateTime    @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt      DateTime    @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))

  customer       Customer    @relation(fields: [customerId], references: [id])
  enterprise     Enterprise  @relation(fields: [enterpriseId], references: [id])
  city           City        @relation(fields: [cityId], references: [id])
  state          State?      @relation(fields: [stateId], references: [id])
  country        Country?    @relation(fields: [countryId], references: [id])

  @@map("deliveryAddress")
}

model Token {
  id           Int        @id @default(autoincrement())
  userId       Int 
  enterpriseId Int 
  token        String     @unique @db.VarChar(512)
  valid        Boolean    @default(true)
  createdAt    DateTime   @default(dbgenerated("CURRENT_TIMESTAMP"))
  expiresAt    DateTime
  updatedAt    DateTime   @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))

  user         User       @relation(fields: [userId], references: [id])
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  @@index([userId])
  @@map("token")
}

model Audit {
  id            Int        @id @default(autoincrement())
  userId        Int
  enterpriseId  Int
  action        String
  entity        String?
  createdAt     DateTime   @default(dbgenerated("CURRENT_TIMESTAMP"))

  user          User       @relation(fields: [userId], references: [id])
  enterprise    Enterprise @relation(fields: [enterpriseId], references: [id])

  @@map("audit")
}

model Log {
  id            Int         @id @default(autoincrement())
  message       String      @db.Text
  stack         String?     @db.Text
  context       String?
  enterpriseId  Int?
  createdAt     DateTime    @default(dbgenerated("CURRENT_TIMESTAMP"))

  enterprise    Enterprise? @relation(fields: [enterpriseId], references: [id])

  @@map("log")
}

model ProductDefinition {
  id            Int                   @id @default(autoincrement())
  enterpriseId  Int
  name          String                @db.VarChar(40)
  description   String?
  type          ProductDefinitionType 
  createdAt     DateTime              @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt     DateTime              @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
           
  enterprise    Enterprise            @relation(fields: [enterpriseId], references: [id])
  product       Product[]

  @@unique([enterpriseId, name])
  @@map("productDefinition")
}

model Unity {
  id            Int        @id @default(autoincrement())
  enterpriseId  Int
  simbol        String     @db.VarChar(8)
  description   String?
  createdAt     DateTime   @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt     DateTime   @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))

  enterprise    Enterprise @relation(fields: [enterpriseId], references: [id])
  product       Product[]

  @@unique([enterpriseId, simbol])
  @@map("unity")
}

model Product {
  id                  Int                @id @default(autoincrement())
  enterpriseId        Int            
  productDefinitionId Int?            
  unityId             Int?            
  name                String             @db.VarChar(80)
  barcode             String?            @db.VarChar(40)
  createdAt           DateTime           @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt           DateTime           @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
 
  enterprise          Enterprise         @relation(fields: [enterpriseId], references: [id])
  productDefinition   ProductDefinition? @relation(fields: [productDefinitionId], references: [id])
  unity               Unity?             @relation(fields: [unityId], references: [id])
  productInventory    ProductInventory?
  inventoryMovement   InventoryMovement[]

  @@map("product")
}

model ProductInventory {
  id           Int        @id @default(autoincrement())
  enterpriseId Int
  productId    Int        @unique
  costValue    Decimal    @db.Decimal(14, 6) 
  saleValue    Decimal    @db.Decimal(14, 6)
  quantity     Decimal    @db.Decimal(14, 6)
  createdAt    DateTime   @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt    DateTime   @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))

  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])
  product      Product    @relation(fields: [productId], references: [id])

  @@unique([enterpriseId, productId])
  @@map("productInventory")
}

model Warehouse {
  id           Int                 @id @default(autoincrement())
  enterpriseId Int      
  code         String              @db.VarChar(20)
  name         String              @db.VarChar(80)
  description  String?             @db.VarChar(120)
      
  enterprise   Enterprise          @relation(fields: [enterpriseId], references: [id])
  movements    InventoryMovement[]

  @@unique([enterpriseId, code])
  @@map("warehouse")
}

model InventoryMovement {
  id              Int                @id @default(autoincrement())
  enterpriseId    Int   
  productId       Int   
  warehouseId     Int   
  lotId           Int?               // controle de lote
  direction       MovementType       
  source          MovementSource     
  quantity        Decimal            @db.Decimal(14, 6)
  unitCost        Decimal?           @db.Decimal(14, 6)
  reference       String?            @db.VarChar(80) // NF, código colheita...
  notes           String?   
  supplierId      Int?               // se for uma compra
  createdAt       DateTime           @default(dbgenerated("CURRENT_TIMESTAMP"))
  updatedAt       DateTime           @default(dbgenerated("CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
   
  enterprise      Enterprise         @relation(fields: [enterpriseId], references: [id])
  product         Product            @relation(fields: [productId], references: [id])
  warehouse       Warehouse          @relation(fields: [warehouseId], references: [id])
  supplier        Supplier?          @relation(fields: [supplierId], references: [id])

  @@index([enterpriseId, productId])
  @@index([warehouseId])
  @@index([direction])
  @@index([source])
  @@map("inventoryMovement")
}
